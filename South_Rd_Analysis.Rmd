---
title: "South Rd Analysis"
author: "Ibrahim Al-Hindi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
# Libraries
library(tidyverse)
library(here)
library(lubridate)
library(ggmap)
library(sf)
library(leaflet)
library(geosphere)
library(geodist)
library(janitor)
library(glue)
```

```{r}
# Data
sites_raw <- read_csv(here("data/addinsight/addinsight_prod.btsites.csv.csv"))
links_south_rd_raw <- read_csv(here("data/South-Rd/BT Links - South Rd.csv"))
full_stops_raw <- read_csv(here("data/GTFS_feed_version_1157/large/gtfs_history_prod.stops.csv"))
routes_trips_stops_raw <- read_csv(here("data/South-Rd/South Rd Routes and Trips gtfs 1157.csv"))
updates_raw <- read_csv(here("data/South-Rd/trip_updates_SouthRd.csv"))
link_stats_raw <- read_csv(here("data/South-Rd/link_stats.csv"))
site_stats_raw <- read_csv(here("data/South-Rd/site_stats.csv"))
```

# Data Wrangling

## Sites

```{r}
# Remove duplicates
sites <- sites_raw %>% 
  distinct(id, .keep_all = TRUE)

rm(sites_raw)

# DF with sites and coordinates only
sites_coords <- sites %>% 
  select(id, longitude, latitude)
```

## Links South Road

```{r}
links_south_rd <- links_south_rd_raw %>% 
  rename_with(tolower) %>% 
  mutate(latitude = round(latitude, 5),
         longitude = round(longitude, 5)) %>%
  # Add start and end longitudes for each link and whether link going down map or up
  group_by(linkid) %>%
  arrange(ordernumber, .by_group = TRUE) %>% 
  mutate(start_lat = ifelse(ordernumber == 0, latitude, NA),
         end_lat = ifelse(ordernumber == max(ordernumber), latitude, NA)) %>% 
  fill(start_lat, .direction = "down") %>% 
  fill(end_lat, .direction = "up") %>%
  mutate(going_up = start_lat < end_lat) %>%  
  ungroup()

rm(links_south_rd_raw)

# Add start and end longitudes for each link and whether link going down map or up
links_south_rd_dir <- links_south_rd %>% 
  group_by(linkid) %>%
  arrange(ordernumber, .by_group = TRUE) %>% 
  mutate(start_lat = ifelse(ordernumber == 0, latitude, NA),
         end_lat = ifelse(ordernumber == max(ordernumber), latitude, NA)) %>% 
  fill(start_lat, .direction = "down") %>% 
  fill(end_lat, .direction = "up") %>%
  mutate(going_up = start_lat < end_lat) %>%  
  ungroup()
```

## Route-Trips-Stops

```{r}
stops_south_rd <- clean_names(routes_trips_stops_raw) %>%
  # Very small part of South Road
  filter(route_id != "982") %>% 
  rename(stop_id = stop_id_gtfs_history_prod_stops_csv) %>% 
  select(stop_id) %>% 
  distinct()
  
rm(routes_trips_stops_raw)
```

## Full Stops

```{r}
full_stops <- full_stops_raw %>% 
  select(stop_id, stop_name, stop_desc, stop_lat, stop_lon) %>% 
  distinct(stop_id, .keep_all = TRUE)

rm(full_stops_raw)
```

## Updates

```{r}
updates <- updates_raw %>% 
  rename(trip_id = id,
         vehicle_id = label) %>%
  mutate(start_date = ymd(start_date),
         timestamp = as_datetime(timestamp),
         arrival_time = as_datetime(arrival_time)) %>% 
  # Get individual stop delay per group
  group_by(route_id, direction_id, start_date, trip_id) %>% 
  arrange(stop_sequence, .by_group = TRUE) %>%
  mutate(stop_delay = delay - lag(delay, default = 0), .after = delay) %>%
  ungroup() %>% 
  # Remove 2021 timestamp entries
  filter(as_date(timestamp) > "2021-12-31") %>% 
  # If a stop_delay is negative, set the stop_delay to zero, because early
  # arrival_time does not matter. Even if stop_delay is negative and arrival_time is
  # is late, the lateness is due to a previous stop
  mutate(stop_delay = ifelse(stop_delay < 0, 0, stop_delay))
  

rm(updates_raw)
```

## Link Stats

```{r}
link_stats <- link_stats_raw %>% 
  select(logtime:closed) %>% 
  mutate(logtime = as_datetime(str_remove(logtime, " \\+10:30"), tz = "UTC")) %>% 
  distinct()

rm(link_stats_raw)
```

## Site Stats

```{r}
site_stats <- site_stats_raw %>% 
  select(logtime:avgduration) %>% 
  mutate(logtime = as_datetime(str_remove(logtime, " \\+10:30"), tz = "UTC"))

rm(site_stats_raw)
```

## Joins

```{r}
# Join stops_south_rd with stops to get stop details
stops_south_rd <- stops_south_rd %>% 
  left_join(full_stops) %>% 
  # If stop is on East side, that means trip going down, and vice versa
  mutate(direction = ifelse(str_detect(stop_name, "East"), "down", "up"))

# Join updates with stops_south_rd
updates_stops_filtered <- updates %>% 
  inner_join(stops_south_rd)
```

# Getting Information for Analysis

## Identify Sites

Select sites from map on South Road between Anzac Highway and Ayliffs Road

```{r}
sites %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(label = ~ id, fillOpacity = 1)
```

Use Google maps to determine coordinates at each intersection of South Road required and get the sites within those coordinates

```{r}
sites_south <- sites %>% 
  filter(str_detect(tolower(name), pattern = "south road") |
           str_detect(tolower(instance_id), pattern = "south road"),
         between(longitude, 138.5710, 138.5763),
         between(latitude, -35.0116, -34.9420))

# Map to double check
sites_south %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(label = ~ id, fillOpacity = 1)
```

## Identify Links

#### Build map going up

```{r}
links_up <- links_south_rd %>% 
  filter(going_up == TRUE)

# Keep one row per linkid for now to see sequence of links
links_dist_up <- links_up %>% 
  distinct(linkid, .keep_all = TRUE) %>%
  # Build map from lower end of map to upper
  arrange(start_lat) %>% 
  # If two links have the same start_lat, keep the one that covers larger distance
  group_by(start_lat) %>% 
  filter(end_lat == max(end_lat)) %>%
  ungroup()
```

```{r}
# Identifying sequence of links with no overlaps

## end_lat to be compared to
flag_up <- links_dist_up$end_lat[1]

## Empty vector to hold linkid's identified in order
links_order_up <- vector("numeric")

## First link in the vector is the link with the lowest latitude
links_order_up[1] <- links_dist_up$linkid[1]

n <- 2

for (i in 2:nrow(links_dist_up)) {
  # Make sure new link lat starts after flag lat ends
  if (links_dist_up$start_lat[i] > flag_up) {
    # Add linkid
    links_order_up[n] <- links_dist_up$linkid[i]
    # Update flag
    flag_up <- links_dist_up$end_lat[i]
    
    n <- n+1
  }
}
```

```{r}
links_map_up <- links_south_rd_dir %>%
  filter(linkid %in% links_order_up) %>% 
  arrange(start_lat, ordernumber)

links_colors <- c("green","yellow")

n <- 1

temp_map_up <- leaflet() %>% 
  addTiles()

# Iterate over links to add polyline of each link to the map
for (link in unique(links_map_up$linkid)) {
  map_df <- links_map_up %>% 
    filter(linkid == link)
  
  temp_map_up <- temp_map_up %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], label = ~linkid, opacity = 0.3)
  
  # Switch colors
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

temp_map_up

# Missing link between Southern Avenue and Celtic Avenue. Locate a link between the two
link_southern_celt_up <- links_south_rd_dir %>%
  filter(str_detect(tolower(name), "southern"),
         str_detect(tolower(name), "celtic"),
         going_up == TRUE)

# Missing link between Daws Road and Corunna Avenue. Locate a link between the two
link_daws_cor_up <- links_south_rd_dir %>%
  filter(str_detect(tolower(name), "daws"),
         str_detect(tolower(name), "corunna"),
         going_up == TRUE)

# Missing link between John Street and Barwell Avenue. Locate a link between the two
link_john_bar_up <- links_south_rd_dir %>%
  filter(str_detect(tolower(name), "john"),
         str_detect(tolower(name), "barwell"),
         going_up == TRUE)

# Check links are correct
temp_map_up %>%
  addPolylines(data = link_southern_celt_up, lng = ~longitude, lat = ~latitude, color = "red", label = ~linkid, opacity = 0.3) %>%
  addPolylines(data = link_daws_cor_up, lng = ~longitude, lat = ~latitude, color = "red", label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_john_bar_up, lng = ~longitude, lat = ~latitude, color = "red", label = ~linkid, opacity = 0.3)

# Combine missing links with map links up DF and plot
links_map_up <- links_map_up %>% 
  rbind(link_southern_celt_up, link_daws_cor_up, link_john_bar_up)

# Output final map up
map_up <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_up$linkid)) {
  map_df <- links_map_up %>% 
    filter(linkid == link)
  
  map_up <- map_up %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "green", opacity = 1)
}

map_up

# Save linkid's going north
links_north <- unique(links_map_up$linkid)
```

#### Build map going down

```{r}
# Same process as map going up above

links_down <- links_south_rd %>% 
  filter(going_up == FALSE)

links_dist_down <- links_down %>% 
  distinct(linkid, .keep_all = TRUE) %>%
  arrange(-start_lat) %>% 
  group_by(start_lat) %>% 
  filter(end_lat == min(end_lat)) %>%
  ungroup()

flag_down <- links_dist_down$end_lat[1]

links_order_down <- vector("numeric")

links_order_down[1] <- links_dist_down$linkid[1]

n <- 2

for (i in 2:nrow(links_dist_down)) {
  if (links_dist_down$start_lat[i] < flag_down) {
    
    links_order_down[n] <- links_dist_down$linkid[i]
    
    flag_down <- links_dist_down$end_lat[i]
    
    n <- n+1
  }
}

links_map_down <- links_south_rd_dir %>%
  filter(linkid %in% links_order_down) %>% 
  arrange(-start_lat, ordernumber)

n <- 1

temp_map_down <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_down$linkid)) {
  map_df <- links_map_down %>% 
    filter(linkid == link)
  
  temp_map_down <- temp_map_down %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], label = ~linkid, opacity = 0.3)
  
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

temp_map_down

# Missing link between Walsh Avenue and Celtic Avenue. Locate a link between the two
link_walsh_celt_down <- links_south_rd_dir %>%
  filter(str_detect(tolower(name), "walsh"),
         str_detect(tolower(name), "celtic"),
         going_up == FALSE)

# Missing link between Daws Road and Corunna Avenue. Locate a link between the two
link_daws_cor_down <- links_south_rd_dir %>%
  filter(str_detect(tolower(name), "daws"),
         str_detect(tolower(name), "corunna"),
         going_up == FALSE)

# Missing link between Edward Street and Albert Street. Locate a link between the two
link_edw_alb_down <- links_south_rd_dir %>%
  filter(str_detect(tolower(name), "edward"),
         str_detect(tolower(name), "albert"),
         going_up == FALSE)

# Missing link between Anzac Highway and Everard Avenue Locate a link between the two
link_anz_ever_down <- links_south_rd_dir %>%
  filter(str_detect(tolower(name), "anzac"),
         str_detect(tolower(name), "everard"),
         going_up == FALSE)

# Check links are correct
temp_map_down %>%
  addPolylines(data = link_walsh_celt_down, lng = ~longitude, lat = ~latitude, color = "red", label = ~linkid, opacity = 0.3) %>%
  addPolylines(data = link_daws_cor_down, lng = ~longitude, lat = ~latitude, color = "red", label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_edw_alb_down, lng = ~longitude, lat = ~latitude, color = "red", label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_anz_ever_down, lng = ~longitude, lat = ~latitude, color = "red", label = ~linkid, opacity = 0.3)

# Combine missing links with map links down DF and plot
links_map_down <- links_map_down %>% 
  rbind(link_walsh_celt_down, link_daws_cor_down, link_edw_alb_down, link_anz_ever_down)

# Output final map down
map_down <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_down$linkid)) {
  map_df <- links_map_down %>% 
    filter(linkid == link)
  
  map_down <- map_down %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "red", opacity = 1)
}

map_down

# Save linkid's going south
links_south <- unique(links_map_down$linkid)
```

```{r}
# Plot links from both directions
map_both <- leaflet() %>% 
  addTiles()

# Add links up map
for (link in unique(links_map_up$linkid)) {
  map_df <- links_map_up %>% 
    filter(linkid == link)
  
  map_both <- map_both %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "green", opacity = 1)
}

# Add links down map
for (link in unique(links_map_down$linkid)) {
  map_df <- links_map_down %>% 
    filter(linkid == link)
  
  map_both <- map_both %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "red", opacity = 1)
}

map_both

# Save linkid's both directions
links_full <- c(links_north, links_south)
```

Links with no stats

```{r}
sort(setdiff(links_full, link_stats$linkid))

links_with_stats <- links_south_rd %>% 
  semi_join(link_stats, by = "linkid")
  
map_links_no_stats <- leaflet() %>% 
  addTiles()

for (link in unique(links_with_stats$linkid)) {
  map_df <- links_with_stats %>% 
    filter(linkid == link)
  
  map_links_no_stats <- map_links_no_stats %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "red", opacity = 1, label = ~linkid)
}

map_links_no_stats
```

## Identify Routes

Routes were identified by examining the [network map](https://www.adelaidemetro.com.au/__data/assets/pdf_file/0009/824247/Adelaide-Metro-network-map.pdf).

All the routes were overlayed on a map on Tableu and routs on South Road were selected and exported.

## Identify Stops

Same as above

```{r}
# Plot on map to check the stops are all on South Rd

stops_south_rd %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(lat = ~stop_lat, lng = ~stop_lon, label = ~ stop_id)
```

# Analysis

## Delays

### Outliers

```{r}
ggplot(updates_stops_filtered, aes(stop_delay)) +
  geom_histogram()

ggplot(updates_stops_filtered, aes(stop_delay)) +
  geom_density()

ggplot(updates_stops_filtered, aes(stop_delay)) +
  geom_dotplot()

ggplot(updates_stops_filtered, aes(stop_delay)) +
  geom_boxplot()
```

Remove stop_delays above 600 (10 minutes)

```{r}
updates_stops_filtered <- updates_stops_filtered %>% 
  filter(stop_delay < 600)
```

## Aggregation

### 5 Minute Aggregation

```{r}
updates_5mins <- updates_stops_filtered  %>% 
  mutate(timestamp = ceiling_date(timestamp, "5 mins")) %>% 
  mutate(time = glue("{hour(timestamp)}:{minute(timestamp)}:{second(timestamp)}"), .after = timestamp)

# Average delay per stop per timestamp per direction
updates_5min_agg <- updates_5mins %>% 
  group_by(timestamp, stop_id, direction) %>% 
  summarise(avg_delay = mean(stop_delay)) %>% 
  ungroup()

# Calculate delay over entire road per timestamp and direction
delay_5mins <- updates_5min_agg %>% 
  group_by(timestamp, direction) %>% 
  summarise(delay = sum(avg_delay)) %>% 
  ungroup()
```









































































