---
title: "Exploration"
author: "Ibrahim Al-Hindi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Libraries
library(tidyverse)
library(here)
library(lubridate)
library(ggmap)
```

# GTFSr

```{r}
# GTFSr Data
updates_raw <- read_csv(here("data/GTFSr/large/gtfsr_prod.trip_updates.SAMPLE.csv.csv"))
positions_raw <- read_csv(here("data/GTFSr/large/gtfsr_prod.vehicle_positions.SAMPLE.csv.csv"))
stops_raw <- read_csv(here("data/GTFS_feed_version_1175/stops.csv"))
```

## Data Wrangling

```{r}
# Adjust column formats
updates <- updates_raw %>% 
  group_by(across(c(-timestamp, -delay, -arrival_time))) %>% 
  filter(timestamp == max(timestamp)) %>% 
  ungroup() %>% 
  mutate(direction_id = factor(direction_id, levels = c(1, 0)),
         start_date = ymd(start_date),
         label = as.character(label),
         wheelchair_accessible = factor(wheelchair_accessible, levels = c(1, 0)),
         timestamp = as_datetime(timestamp),
         id = as.character(id),
         stop_id = as.character(stop_id),
         arrival_time = as_datetime(arrival_time),
         date = date(timestamp),
         wday = wday(timestamp, label = TRUE, abbr = TRUE, week_start = 1),
         hour = hour(timestamp),
         time_stamp_floor = floor_date(timestamp, unit = "hour")) %>% 
  rename(trip_id = id,
         vehicle_id = label)

# Remove original file
rm(updates_raw)
```

## Exploration

### Updates

```{r}
# Updates Understanding the data
## trip_id can occur in different dates using different vehicles, might be unique for each start_time
updates %>%
  group_by(trip_id) %>% 
  summarise(
    routes = n_distinct(route_id),
    directions = n_distinct(direction_id),
    dates = n_distinct(start_date),
    vehicles = n_distinct(vehicle_id),
    all = n_distinct(route_id, direction_id, start_date, vehicle_id)) %>% 
  arrange(-all)

## Multiple trip_id can occur using the same combination of variables in group_by,
## need start_time
updates %>% 
  group_by(route_id, direction_id, start_date, vehicle_id) %>% 
  summarise(trips = n_distinct(trip_id)) %>% 
  arrange(-trips)
```

```{r}
# delay per date and weekday
updates %>% 
  group_by(date, wday) %>% 
  summarise(avg_delay = mean(delay)) %>% 
  ggplot(aes(x = date, y = avg_delay)) +
  geom_line(size = 2, alpha = 0.2) +
  geom_line(aes(color = wday)) +
  scale_color_brewer(type = "qual")

# delay per weekday
updates %>% 
  group_by(wday) %>% 
  summarise(avg_delay = mean(delay)) %>% 
  ggplot(aes(x = wday, y = avg_delay)) +
  geom_col()
```

Average delays have an increasing trend in January, and are actually mostly early. The trend is likely due to new years holidays and vacation days. Saturdays had the highest delays by far. The rest of the days are similar and early

```{r}
# Delays per stop
stops_delays <- updates %>% 
  group_by(stop_id) %>% 
  summarise(avg_delay = mean(delay),
            no_of_trips =n()) %>% 
  mutate(delay_mins = avg_delay/60) %>% 
  arrange(-avg_delay)

top10_delays <- stops_delays %>% 
  slice_head(n = 10) %>% 
  # Filter out train substitute services
  filter(stop_id %in% c(107, 130, 141, 79, 86))

# Delays per stop and hour
stops_hours_delays <- updates %>% 
  group_by(stop_id, hour) %>% 
  summarise(avg_delay = mean(delay)) %>% 
  mutate(delay_mins = avg_delay/60) %>% 
  arrange(-avg_delay)

shd_over1hr <- stops_hours_delays %>% 
  filter(delay_mins >= 60) %>% 
  # 1pm has the most delays
  filter(hour == 13)

# Extract trips that have the stops above at 1pm
updates %>% 
  semi_join(shd_over1hr)
# The culprit is one trip on 6/1/2022. Ignore
# This method is not good, try switching back to delays per stop

# Pick one of the stops to investigate
stop_107 <- updates %>% 
  filter(stop_id == 107)
# The same trip on the same date for the same stop can have multiple delay updates,
# therefore filter updates to the most recent timestamp. This will be done in the
# data cleaning chunk above.


# Filter updates to contain the top10 stops above
updates %>% 
  semi_join(top10_delays) %>%
  ggplot(aes(x = timestamp, y = delay, color = stop_id)) +
  geom_line()
```

Continue with these five stops for the remainder of the analysis.

```{r}
# Data wrangle stops
stops <- stops_raw %>% 
  mutate(stop_id = as.character(stop_id))
```


```{r}
intersections <- updates %>% 
  semi_join(top10_delays) %>% 
  # retrieve coordinates from stops file
  left_join(stops) %>% 
  select(route_id:stop_lon)

unique(intersections$route_id)
```

All stops are part of a single route: 443


```{r}
# map stops
ints_map <- get_map(c(left = min(stops$stop_lon) - 0.005,
                      bottom = min(stops$stop_lat) - 0.005,
                      right = max(stops$stop_lon) + 0.005,
                      top = max(stops$stop_lat) + 0.005),
                    source = "stamen")

ggmap(ints_map) +
  geom_point(data = intersections, aes(x = stop_lon, y = stop_lat), color = "red") +
  theme_void()


# zoom in
# Coordinates retrieved from https://www.openstreetmap.org/export#map=12/-34.6943/138.6887
ints_map_zoom <- get_map(c(left = 138.4851,
                      bottom = -34.7873,
                      right = 138.8923,
                      top = -34.6012),
                    source = "stamen")

ggmap(ints_map) +
  geom_point(data = intersections, aes(x = stop_lon, y = stop_lat), color = "red") +
  theme_void()

```

































### Positions

```{r}
positions <- positions_raw %>% 
  mutate(trip_id = as.character(trip_id),
         start_date = ymd(start_date),
         direction_id = factor(direction_id, levels = c(1, 0)),
         vehicle_id = as.character(vehicle_id),
         wheelchair_accessible = factor(wheelchair_accessible, levels = c(1, 0)))
```



```{r}
# Positions Understanding the data
## Each id is composed of trip_id + vehicle_id
positions %>% 
  group_by(id) %>% 
  summarise(n = n_distinct(trip_id, vehicle_id)) %>% 
  arrange(-n)
```






















