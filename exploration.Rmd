---
title: "Exploration"
author: "Ibrahim Al-Hindi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Libraries
library(tidyverse)
library(here)
library(lubridate)
library(ggmap)
library(tidytransit)
library(sf)
library(plotly)
```

```{r}
# GTFSr Data
updates_raw <- read_csv(here("data/GTFSr/large/gtfsr_prod.trip_updates.SAMPLE.csv.csv"))
stops_raw <- read_csv(here("data/GTFS_feed_version_1157/large/gtfs_history_prod.stops.csv"))
routes_raw <- read_csv(here("data/GTFS_feed_version_1157/gtfs_history_prod.routes.csv"))
```

## Data Wrangling

```{r}
# Updates
updates <- updates_raw %>%
  # The same trip on the same date for the same stop can have multiple delay updates,
  # therefore filter updates to the most recent timestamp
  group_by(route_id, direction_id, start_date, id, stop_sequence, stop_id) %>%
  filter(timestamp == max(timestamp)) %>%
  ungroup() %>% 
  mutate(direction_id = factor(direction_id, levels = c(1, 0)),
         start_date = ymd(start_date),
         label = as.character(label),
         timestamp = as_datetime(timestamp),
         id = as.character(id),
         stop_id = as.character(stop_id),
         arrival_time = as_datetime(arrival_time),
         date = date(timestamp),
         wday = wday(timestamp, label = TRUE, abbr = TRUE, week_start = 1),
         hour = hour(timestamp),
         time_stamp_floor = floor_date(timestamp, unit = "hour")) %>% 
  rename(trip_id = id,
         vehicle_id = label) %>% 
  # Get stop to stop delay per group
  group_by(route_id, direction_id, start_date, trip_id) %>% 
  arrange(stop_sequence, .by_group = TRUE) %>% 
  mutate(stop_to_stop_delay = c(0, diff(delay)), .after = delay) %>% 
  ungroup() %>% 
  mutate(delay_mins = delay/60, .after = delay) %>%
  mutate(stop_to_stop_delay_mins = stop_to_stop_delay/60, .after = stop_to_stop_delay)
 
rm(updates_raw)

# Routes
routes <- routes_raw %>%
  distinct(route_id, .keep_all = TRUE) %>% 
  select(route_id, route_long_name:route_type, route_color, routegroup) %>%
  filter(
    # filter to buses only
    route_type == 3,
    # no train substitutes or hail n' ride services
    !str_detect(tolower(route_desc), pattern = "train substitute service|hail")) %>%
  mutate(route_color = paste0("#", route_color))

rm(routes_raw)

# Stops
stops <- stops_raw %>%
  distinct(stop_id, .keep_all = TRUE) %>% 
  select(stop_id, stop_name:stop_lon) %>% 
  mutate(stop_id = as.character(stop_id))
  
rm(stops_raw)

# Join
combined <- updates %>%
  inner_join(routes, by = "route_id") %>% 
  inner_join(stops, by = "stop_id")
```

## Exploration

### Updates

```{r}
# Multiple vehicles can doing the same trip on the same day very rare. Disregard
combined %>% 
  group_by(route_id, trip_id, start_date, direction_id) %>% 
  summarise(n = n_distinct(vehicle_id)) %>%
  ungroup() %>% 
  count(n)

## Multiple trip_id can occur using the same combination of variables in group_by,
## need start_time
combined %>% 
  group_by(route_id, start_date, vehicle_id) %>% 
  summarise(trips = n_distinct(trip_id)) %>% 
  arrange(-trips)
```

```{r}
# delay per date and weekday
combined %>% 
  group_by(date, wday) %>% 
  summarise(avg_delay = mean(delay_minutes)) %>% 
  ggplot(aes(x = date, y = avg_delay)) +
  geom_line(size = 2, alpha = 0.2) +
  geom_line(aes(color = wday)) +
  scale_color_brewer(type = "qual")

# delay per weekday
combined %>% 
  group_by(wday) %>% 
  summarise(avg_delay = mean(delay_minutes)) %>% 
  ggplot(aes(x = wday, y = avg_delay)) +
  geom_col()
```

Barely any delays


## Delays

### Delays per Stop

```{r}
stops_delays <- combined %>% 
  group_by(stop_id, direction_id) %>% 
  summarise(avg_delay = mean(delay_minutes),
            occurrences = n()) %>%
  ungroup() %>%
  # Only include stop with number of occurrences greater than the median, indicates
  # abundance of data and importance of stop
  filter(occurrences > median(occurrences)) %>%
  arrange(-avg_delay)

# Select top 5 delays per stop_id
top_stops_delays <- stops_delays %>%
  slice_head(n=5)

stops_combined <- combined %>% 
  semi_join(top_stops_delays, by = c("stop_id", "direction_id")) %>%
  mutate(stop_direction = paste0(stop_id, "-", direction_id))

stops_combined %>% 
  ggplot(aes(x = timestamp, y = delay_minutes, color = stop_direction)) +
  geom_point() +
  geom_line()
```

## Delays per Route per Direction

```{r}
routes_delays <- combined %>%
  # Remove exceptional cases
  #filter(!(route_id %in% c("224M", "225M", "492A", "750B", "864", "743") & delay_minutes > 30)) %>% 
  group_by(route_id, direction_id) %>%
  summarise(avg_delay = mean(delay_minutes),
            # A start_date can have several trip_id's, and a trip_id can have
            # several start_dates, so count unique combinations of each
            no_of_trips = n_distinct(start_date, trip_id),
            no_of_days = n_distinct(start_date),
            no_of_unique_trips = n_distinct(trip_id),
            route_name = unique(route_long_name),
            route_desc = unique(route_desc),
            route_group = unique(routegroup),
            route_color = unique(route_color)) %>%
  ungroup() %>% 
  filter(no_of_trips > median(no_of_trips)) %>%
  arrange(-avg_delay)

top_routes_delays <- routes_delays %>% 
  slice_head(n=5)

routes_combined <- combined %>% 
  semi_join(top_routes_delays, by = c("route_id", "direction_id")) %>%
  mutate(route_direction = paste0(route_id, "-", direction_id)) 

ggplot(routes_combined, aes(x = timestamp, y = delay_minutes, color = route_direction)) +
  geom_point() +
  geom_line()
```

## Delays per Hour

```{r}
hourly_delays <- combined %>%
  group_by(hour) %>% 
  summarise(avg_delay = mean(delay_minutes)) %>%
  ungroup() %>%
  arrange(hour)

ggplot(hourly_delays, aes(hour, avg_delay)) +
  geom_line() +
  scale_x_continuous(breaks = seq(0,23)) +
  theme(panel.grid.minor = element_blank())
```

### Delays per Route per Direction per Hour
```{r}
routes_hourly_delays <- combined %>%
  group_by(route_id, hour) %>% 
  summarise(avg_delay = mean(delay_minutes),
            occurrences = n(),
            no_of_trips = n_distinct(trip_id),
            route_name = unique(route_long_name),
            route_desc = unique(route_desc),
            route_group = unique(routegroup),
            route_color = unique(route_color)) %>%
  ungroup() %>%
  # Filter out routes that are train substitutes or hail n' rides
  filter(!str_detect(tolower(route_desc), pattern = "train substitute|hail")) %>% 
  arrange(-avg_delay)

combined %>% 
  group_by(route_id) %>% 
  summarise(n = n_distinct(direction_id)) %>% 
  count(n)
```













# Map

```{r}
# Obtain shapes required per shape_id in stops_combined
stops_shapes <- shapes %>% 
  semi_join(stops_combined, by = "shape_id") %>% 
  arrange(shape_id, shape_pt_sequence)

stops_shapes_sf <- st_as_sf(stops_shapes, coords = c("shape_pt_lat", "shape_pt_lon"))

# Map method 1
ggplot() +
  geom_path(data = shapes, aes(shape_pt_lon, shape_pt_lat, group=shape_id), size=.2, alpha=.1) +
  coord_fixed()

# Map method 2
bbox <- c(138.454415,-35.206164,138.742257,-34.660694)

ggplot(stops_shapes_sf) +
  geom_sf(data = stops_shapes_sf, aes(color = shape_id))
```








```{r}
stops_combined %>% 
  group_by(route_id, direction_id, service_id) %>% 
  summarise(n = n_distinct(shape_id)) %>% 
  arrange(-n)
```





















```{r}
# Coordinates retrieved from https://www.openstreetmap.org/export#map=12/-34.6943/138.6887
ints_map <- get_map(c(left = 138.4387,
                      bottom = -35.2546,
                      right = 138.7628,
                      top = -34.6648),
                    source = "stamen")

# sites and top stops locations
ggmap(ints_map) +
  geom_point(data = stops_combined, aes(x = stop_lon, y = stop_lat), color = "red", alpha = 0.3, size = 2) +
  geom_point(data = sites_raw, aes(x = longitude, y = latitude), color = "blue", alpha = 0.3, size = 2) +
  theme_void()


```











































