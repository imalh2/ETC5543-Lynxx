---
title: "South Rd Analysis"
author: "Ibrahim Al-Hindi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r libraries}
# Libraries
library(tidyverse)
library(here)
library(lubridate)
library(leaflet)
library(hms)
library(janitor)
```

```{r data}
# Data
sites_raw <- read_csv(here("data/addinsight/addinsight_prod.btsites.csv.csv"))
links_segment_raw <- read_csv(here("data/South-Rd/BT Links - South Rd.csv"))
full_stops_raw <- read_csv(here("data/GTFS_feed_version_1157/large/gtfs_history_prod.stops.csv"))
routes_trips_stops_raw <- read_csv(here("data/South-Rd/South Rd Routes and Trips gtfs 1157.csv"))
updates_raw <- read_csv(here("data/South-Rd/trip_updates_SouthRd_Mar.csv"))
link_stats_raw <- read_csv(here("data/South-Rd/link_stats_Mar.csv"))
site_stats_raw <- read_csv(here("data/South-Rd/site_stats_Mar.csv"))
holidays_raw <- read_csv(here("data/addinsight/addinsight_prod.btspecialdays.csv.csv"))
```

# Data Wrangling and Exploration

## Holidays

```{r}
holidays <- unique(holidays_raw$date)

rm(holidays_raw)
```

## Sites

```{r}
# Remove duplicates
sites <- sites_raw %>% 
  distinct(id, .keep_all = TRUE)

rm(sites_raw)
```

## Links Segment

```{r}
links_segment <- links_segment_raw %>% 
  rename_with(tolower) %>% 
  mutate(latitude = round(latitude, 5),
         longitude = round(longitude, 5)) %>%
  # Add start and end longitudes for each link and whether link going to or from city
  # to identify non-overlapping sequence of links later
  group_by(linkid) %>%
  mutate(start_lat = first(latitude, order_by = ordernumber),
         end_lat = last(latitude, order_by = ordernumber)) %>% 
  ungroup() %>% 
  mutate(direction = if_else(start_lat < end_lat, "to_city", "from_city"))

rm(links_segment_raw)
```

## Full Stops and Route-Trips-Stops

```{r}
routes_trips_stops <- clean_names(routes_trips_stops_raw)

stops_segment <- full_stops_raw %>% 
  semi_join(routes_trips_stops, by = c("stop_id" = "stop_id_gtfs_history_prod_stops_csv")) %>% 
  select(stop_id, stop_name, stop_desc, stop_lat, stop_lon) %>% 
  distinct(stop_id, .keep_all = TRUE) %>% 
  # If stop is on East side, that means trip going down, and vice versa
  mutate(direction = if_else(str_detect(stop_name, "East"), "from_city", "to_city"))

rm(full_stops_raw)
```

## Updates

```{r}
updates <- updates_raw %>%
  rename(trip_id = id,
         vehicle_id = label) %>% 
  mutate(start_date = ymd(start_date),
         timestamp = as_datetime(timestamp, tz = "Australia/Adelaide"),
         arrival_time = as_datetime(arrival_time, tz = "Australia/Adelaide")) %>%
  # Only segment stops and get direction
  inner_join(select(stops_segment, stop_id, direction), by = "stop_id") %>% 
  # Remove weekends and public holidays
  filter(!start_date %in% holidays,
         !wday(start_date, label = TRUE) %in% c("Sat", "Sun")) %>%
  group_by(start_date, trip_id) %>%
  # To join later with first and last stop pairs on segment
  mutate(first_stop = first(stop_id, order_by = stop_sequence),
         last_stop = last(stop_id, order_by = stop_sequence)) %>%
  ungroup()

# Take top 2 occurring stops pair for each direction according to cumsum plot
top_first_last_stops <- updates %>% 
  distinct(start_date, trip_id, direction, first_stop, last_stop) %>%
  group_by(direction) %>% 
  count(first_stop, last_stop, sort = TRUE) %>% 
  slice_max(order_by = n, n = 3) %>% 
  mutate(cumsum = cumsum(n),
         pairs = row_number()) %>% 
  ungroup()

updates_stop_times <- updates %>% 
  # Keep updates for trips that have first and last stop from pairs identified
  semi_join(top_first_last_stops, by = c("direction", "first_stop", "last_stop")) %>%
  group_by(start_date, trip_id) %>%
  arrange(stop_sequence, .by_group = TRUE) %>%
  # Remove trips where all the stops have a delay over 4000, ie entire trip is delayed.
  # Most likely error due to entering the information later. This is done to prevent
  # incorrectly influencing time aggregated figures since they're going to be in
  # the wrong time aggregate
  filter(!(all(delay > 4000))) %>%
  # Remove one-off large jumps in between two observations
  filter(!(delay - lag(delay, order_by = stop_sequence, default = 0) > 1000 &
             delay - lead(delay, order_by = stop_sequence, default = 0) > 1000)) %>%
  # Remove any observations that have an arrival_time later than any following
  # arrival_time in the trip AND the timestamp is earlier than any following timestamps in the trip.
  # This ensures the most recent timestamp is preferred when discrepancy occurs
  filter(!(as.numeric(arrival_time) > order_by(-stop_sequence, cummin(as.numeric(arrival_time))) &
             as.numeric(timestamp) == order_by(-stop_sequence, cummin(as.numeric(timestamp))))) %>%
  # Remove if the arrival_time is less than the previous arrival_times AND the timestamp
  # is older than the previous timestamps
  filter(!(arrival_time < order_by(stop_sequence, cummax(as.numeric(arrival_time))) &
             timestamp < order_by(stop_sequence, cummax(as.numeric(timestamp))))) %>%
  # If arrival_time of a stop is less than prior stops but they all have the same
  # timestamp, it's not possible to know which is correct. Assume earlier stop_sequence
  # is correct since it is closer when the update is made
  filter(!(timestamp == order_by(stop_sequence, cummax(as.numeric(timestamp))) &
           arrival_time < order_by(stop_sequence, cummax(as.numeric(arrival_time))))) %>%
  # If after the above two consecutive stops have the same arrival_time, remove
  # the one with an older timestamp
  filter(!(arrival_time == lead(arrival_time, order_by = stop_sequence,
                                default = ymd("9999-01-01", tz = "UTC")) &
           timestamp < lead(timestamp, order_by = stop_sequence,
                            default = ymd("9999-01-01", tz = "UTC")))) %>%
  # If two stops have the same arrival_time and same time_stamp, remove the one
  # with a higher stop sequence. Make sure only 2 stops and not more
  filter(!(arrival_time != lead(arrival_time, order_by = stop_sequence,
                                default = ymd("9999-01-01", tz = "UTC")) &
             arrival_time == lag(arrival_time, order_by = stop_sequence,
                                 default = ymd("0000-01-01", tz = "UTC")) &
           timestamp == lag(timestamp, order_by = stop_sequence,
                            default = ymd("0000-01-01", tz = "UTC")))) %>%
  # Remove trips with multiple repeating arrival_times
  filter(!n_distinct(arrival_time) < n()) %>%
  mutate(#prior_stamp = lag(timestamp),
         #prior_arrival = lag(arrival_time),
         #post_arrival = lead(arrival_time),
         to_stop_time = as.numeric(arrival_time - lag(arrival_time), units = "secs"),
         # Reidetify first and last stops per trip
         first_stop = first(stop_id, order_by = stop_sequence),
         last_stop = last(stop_id, order_by = stop_sequence)) %>% 
         #delay_diff = delay - lag(delay, default = 0)) %>% 
         #prior_stop_time = lag(to_stop_time, default = 0)) %>% 
         #post_stop_time = lead(to_stop_time, default = 0),) %>%
  ungroup() %>%
  mutate(to_stop_time = replace_na(to_stop_time, 0))
         #prior_stop_time = replace_na(prior_stop_time, 0))
         #post_stop_time = replace_na(post_stop_time, 0)) %>%

# Take top 2 occurring stops pair AGAIN for each direction according to cumsum plot
top_first_last_stops2 <- updates_stop_times %>% 
  distinct(start_date, trip_id, direction, first_stop, last_stop) %>%
  group_by(direction) %>% 
  count(first_stop, last_stop, sort = TRUE) %>% 
  slice_max(order_by = n, n = 2) %>% 
  mutate(cumsum = cumsum(n),
         pairs = row_number()) %>% 
  ungroup()

# Rejoin to only stops pairs identified
updates_stop_times <- updates_stop_times %>% 
   semi_join(top_first_last_stops2, by = c("direction", "first_stop", "last_stop"))

updates_trip_time <- updates_stop_times %>% 
  group_by(start_date, trip_id) %>%
  arrange(stop_sequence, .by_group = TRUE) %>%
  mutate(trip_time = as.numeric((last(arrival_time) -
                                   first(arrival_time)), 
                                units = "secs"),
         first_last = paste(first_stop, last_stop, sep = "-")) %>%
  ungroup() %>%
  # Remove outliers, most likely due to sudden high delays in trip possibly by error
  filter(trip_time < 1650) %>% 
  arrange(start_date, trip_id, stop_sequence)

# One row per trip corresponding to highest delay in the trip
trip_time_delay <- updates_trip_time %>% 
  group_by(start_date, trip_id) %>% 
  filter(abs(delay) == max(abs(delay))) %>%
  ungroup() %>% 
  distinct(start_date, trip_id, .keep_all = TRUE)

# One row per trip corresponding to highest to_stop_time in the trip
trip_time_stop <- updates_trip_time %>% 
  group_by(start_date, trip_id) %>% 
  filter(abs(to_stop_time) == max(abs(to_stop_time))) %>%
  ungroup() %>% 
  distinct(start_date, trip_id, .keep_all = TRUE)

# For further analysis, take first stop only from each trip because the arrival_time
# of the first stop will be used as the basis for aggregation
trip_times <- updates_trip_time %>% 
  group_by(start_date, trip_id) %>% 
  filter(stop_sequence == first(stop_sequence, order_by = stop_sequence)) %>%
  ungroup() %>% 
  distinct(start_date, trip_id, .keep_all = TRUE)

# Join with trip_time_delay to only have trips analysed
stop_times <- updates_stop_times %>% 
  semi_join(updates_trip_time, by = c("start_date", "trip_id"))

rm(updates_raw)
```

```{r}
top_first_last_stops2 %>% 
  ggplot(aes(pairs, cumsum)) +
  geom_line() +
  facet_wrap(vars(direction)) +
  theme_minimal()
```

## Data Validation

```{r}
# ggplot(updates_stop_times,aes(delay_diff)) +
#   geom_boxplot() +
#   theme_minimal()
# 
# ggplot(updates_stop_times,aes(to_stop_time, delay_diff)) +
#   geom_point() +
#   theme_minimal()

ggplot(updates_stop_times, aes(to_stop_time)) +
  geom_histogram() +
  theme_minimal()

ggplot(updates_stop_times, aes(to_stop_time)) +
  geom_boxplot() +
  theme_minimal()

ggplot(updates_stop_times, aes(delay)) +
  geom_histogram() +
  theme_minimal()

ggplot(updates_stop_times, aes(delay)) +
  geom_boxplot() +
  theme_minimal()

ggplot(updates_stop_times, aes(to_stop_time, delay)) +
  geom_point() +
  theme_minimal()

ggplot(stop_times, aes(to_stop_time)) +
  geom_histogram() +
  theme_minimal()

ggplot(stop_times, aes(to_stop_time)) +
  geom_boxplot() +
  theme_minimal()

ggplot(stop_times, aes(delay)) +
  geom_histogram() +
  theme_minimal()

ggplot(stop_times, aes(delay)) +
  geom_boxplot() +
  theme_minimal()

ggplot(stop_times, aes(to_stop_time, delay)) +
  geom_point() +
  theme_minimal()

ggplot(updates_trip_time, aes(trip_time)) +
  geom_histogram() +
  theme_minimal()

ggplot(updates_trip_time, aes(trip_time)) +
  geom_boxplot() +
  theme_minimal()

ggplot(updates_trip_time, aes(trip_time, to_stop_time)) +
  geom_point() +
  theme_minimal()

ggplot(updates_trip_time, aes(trip_time, delay)) +
  geom_point() +
  theme_minimal()

ggplot(trip_time_delay, aes(trip_time, delay, colour = first_last)) +
  geom_point() +
  facet_wrap(vars(direction)) +
  theme_minimal()

ggplot(trip_time_stop, aes(trip_time, to_stop_time, colour = first_last)) +
  geom_point() +
  facet_wrap(vars(direction)) +
  theme_minimal()

ggplot(trip_times, aes(trip_time, color = direction)) +
  geom_boxplot() +
  theme_minimal()

ggplot(trip_times, aes(trip_time, color = direction)) +
  geom_density() +
  theme_minimal()

ggplot(trip_times, aes(trip_time, color = first_last)) +
  geom_boxplot() +
  facet_wrap(vars(direction)) +
  theme_minimal()

ggplot(trip_times, aes(trip_time, color = first_last)) +
  geom_density() +
  facet_wrap(vars(direction)) +
  theme_minimal()
```

## Link Stats

```{r}
link_stats <- link_stats_raw %>% 
  select(logtime:closed) %>%
  mutate(logtime = as_datetime(str_remove(logtime, " \\+10:30"))) %>%
  filter(!as_date(logtime) %in% holidays,
         !wday(logtime, label = TRUE) %in% c("Sat", "Sun"),
         enoughdata == TRUE) %>% 
  distinct()

# Join link_stats with links_segment to get direction
link_stats <- link_stats %>% 
  left_join(select(links_segment, linkid, direction))

rm(link_stats_raw)

summary(link_stats)

ggplot(link_stats, aes(congestion)) +
  geom_histogram(binwidth = 1)

ggplot(link_stats, aes(congestion)) +
  geom_density()

ggplot(link_stats, aes(congestion)) +
  geom_boxplot()
```

## Site Stats

```{r}
site_stats <- site_stats_raw %>% 
  select(logtime:avgduration) %>% 
  mutate(logtime = as_datetime(str_remove(logtime, " \\+10:30"))) %>%
  filter(!as_date(logtime) %in% holidays,
         !wday(logtime, label = TRUE) %in% c("Sat", "Sun")) %>% 
  distinct()

rm(site_stats_raw)

ggplot(site_stats, aes(probecount)) +
  geom_histogram()

ggplot(site_stats, aes(probecount)) +
  geom_density()

ggplot(site_stats, aes(probecount)) +
  geom_boxplot()

ggplot(site_stats, aes(avgduration)) +
  geom_histogram()

ggplot(site_stats, aes(avgduration)) +
  geom_density()

ggplot(site_stats, aes(avgduration)) +
  geom_boxplot()

ggplot(site_stats, aes(x = probecount, y = avgduration)) +
  geom_point()
```

# Getting Information for Analysis

## Identify Sites

Select sites from map on South Road between Anzac Highway and Ayliffs Road

```{r}
sites %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(label = ~ id, fillOpacity = 1)
```

Use Google maps to determine coordinates at each intersection of South Road required and get the sites within those coordinates

```{r}
sites_south <- sites %>% 
  filter(str_detect(tolower(name), pattern = "south road") |
           str_detect(tolower(instance_id), pattern = "south road"),
         between(longitude, 138.5710, 138.5763),
         between(latitude, -35.0116, -34.9420))

# Map to double check
sites_south %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(label = ~ id, fillOpacity = 1)
```

## Identify Links

```{r}
# OLD METHOD

# DF with sites and coordinates only
# sites_coords <- sites %>% 
#   select(id, longitude, latitude)

# ## Links DF for leaflet
# ### add origin site coordinates
# links_origin <- links %>% 
#   left_join(sites_coords, by = c("originid" = "id"))
# ### add destination site coordinates
# links_dest <- links %>% 
#   left_join(sites_coords, by = c("destid" = "id"))
# ### Row bind links_south_origin and links_south_dest
# links_leaflet <- bind_rows("origin" = links_origin, "dest" = links_dest, .id = "point") %>% 
#   arrange(id)

# Get all links that have a start site and end site in the sites identified

# links_south <- links_leaflet %>% 
#   filter(originid %in% sites_south$id,
#          destid %in% sites_south$id)
# 
# # Map to check the sites are all in the correct spot. They are
# links_south %>% 
#   leaflet() %>% 
#     addTiles() %>% 
#     addPolylines(lng = ~longitude, lat = ~latitude, group = ~id)

# Next: need to select sites along the road but do not overlap
```


### Build map going to city

```{r}
links_to_city <- links_segment %>% 
  filter(direction == "to_city")

# Keep one row per linkid for now to see sequence of links
links_dist_to_city <- links_to_city %>% 
  distinct(linkid, .keep_all = TRUE) %>%
  # Build map from lower end of map to upper
  arrange(start_lat) %>% 
  # If two links have the same start_lat, keep the one that covers larger distance
  group_by(start_lat) %>% 
  filter(end_lat == max(end_lat)) %>%
  ungroup()
```

```{r}
# Identifying sequence of links with no overlaps

## end_lat to be compared to
flag_to_city <- links_dist_to_city$end_lat[1]

## Empty vector to hold linkid's identified in order
links_order_to_city <- vector("numeric")

## First link in the vector is the link with the lowest latitude
links_order_to_city[1] <- links_dist_to_city$linkid[1]

n <- 2

for (i in 2:nrow(links_dist_to_city)) {
  # Make sure new link lat starts after flag lat ends
  if (links_dist_to_city$start_lat[i] > flag_to_city) {
    # Add linkid
    links_order_to_city[n] <- links_dist_to_city$linkid[i]
    # Update flag
    flag_to_city <- links_dist_to_city$end_lat[i]
    
    n <- n+1
  }
}
```

```{r}
links_map_to_city <- links_segment %>%
  filter(linkid %in% links_order_to_city) %>% 
  arrange(start_lat, ordernumber)

links_colors <- c("green","yellow")

n <- 1

temp_map_to_city <- leaflet() %>% 
  addTiles()

# Iterate over links to add polyline of each link to the map
for (link in unique(links_map_to_city$linkid)) {
  map_df <- links_map_to_city %>% 
    filter(linkid == link)
  
  temp_map_to_city <- temp_map_to_city %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n],
                 label = ~linkid, opacity = 0.3)
  
  # Switch colors
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

temp_map_to_city

# Remove problematic links and insert replacement links either because links
# don't appear right on the map or because stats for the link don't exist
links_order_to_city <- c(links_order_to_city[!links_order_to_city %in% c(289, 697, 3573, 3574)],
                    1966, 2871, 2869, 1962, 1970, 1972)

# Update with changes
links_map_to_city <- links_segment %>%
  filter(linkid %in% links_order_to_city) %>% 
  arrange(start_lat, ordernumber)

# Missing link between School Avenue and Everard Avenue. Locate a link between the two
link_school_eve_to_city <- links_segment %>%
  filter(str_detect(tolower(name), "school"),
         str_detect(tolower(name), "everard"),
         direction == "to_city")

# Missing link between Southern Avenue and Celtic Avenue. Locate a link between the two
link_southern_celt_to_city <- links_segment %>%
  filter(str_detect(tolower(name), "southern"),
         str_detect(tolower(name), "celtic"),
         direction == "to_city")

# Missing link between Daws Road and Corunna Avenue. Locate a link between the two
link_daws_cor_to_city <- links_segment %>%
  filter(str_detect(tolower(name), "daws"),
         str_detect(tolower(name), "corunna"),
         direction == "to_city")

# Missing link between John Street and Barwell Avenue. Locate a link between the two
link_john_bar_to_city <- links_segment %>%
  filter(str_detect(tolower(name), "john"),
         str_detect(tolower(name), "barwell"),
         direction == "to_city")

temp_map_to_city2 <- leaflet() %>% 
  addTiles()

# Iterate over links to add polyline of each link to the map
for (link in unique(links_map_to_city$linkid)) {
  map_df <- links_map_to_city %>% 
    filter(linkid == link)
  
  temp_map_to_city2 <- temp_map_to_city2 %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n],
                 label = ~linkid, opacity = 0.3)
  
  # Switch colors
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

# Check links are correct
temp_map_to_city2 %>%
  addPolylines(data = link_southern_celt_to_city, lng = ~longitude, lat = ~latitude, color = "red",
               label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_daws_cor_to_city, lng = ~longitude, lat = ~latitude, color = "red",
               label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_john_bar_to_city, lng = ~longitude, lat = ~latitude, color = "red",
               label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_school_eve_to_city, lng = ~longitude, lat = ~latitude, color = "red",
               label = ~linkid, opacity = 0.3)

# Combine missing links with map links up DF and plot
links_map_to_city <- links_map_to_city %>% 
  rbind(link_southern_celt_to_city, link_daws_cor_to_city, link_john_bar_to_city, link_school_eve_to_city) %>% 
  arrange(start_lat, ordernumber)

# Output final map up
map_to_city <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_to_city$linkid)) {
  map_df <- links_map_to_city %>% 
    filter(linkid == link)
  
  map_to_city <- map_to_city %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], opacity = 0.3, label = ~linkid)
  
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

map_to_city

# Save linkid's going north
links_north <- unique(links_map_to_city$linkid)
```

### Build map going down

```{r}
# Same process as map going up above

links_from_city <- links_segment %>% 
  filter(direction == "from_city")

links_dist_from_city <- links_from_city %>% 
  distinct(linkid, .keep_all = TRUE) %>%
  arrange(-start_lat) %>% 
  group_by(start_lat) %>% 
  filter(end_lat == min(end_lat)) %>%
  ungroup()

flag_from_city <- links_dist_from_city$end_lat[1]

links_order_from_city <- vector("numeric")

links_order_from_city[1] <- links_dist_from_city$linkid[1]

n <- 2

for (i in 2:nrow(links_dist_from_city)) {
  if (links_dist_from_city$start_lat[i] < flag_from_city) {
    
    links_order_from_city[n] <- links_dist_from_city$linkid[i]
    
    flag_from_city <- links_dist_from_city$end_lat[i]
    
    n <- n+1
  }
}

links_map_from_city <- links_segment %>%
  filter(linkid %in% links_order_from_city) %>% 
  arrange(-start_lat, ordernumber)

n <- 1

temp_map_from_city <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_from_city$linkid)) {
  map_df <- links_map_from_city %>% 
    filter(linkid == link)
  
  temp_map_from_city <- temp_map_from_city %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], label = ~linkid, opacity = 0.3)
  
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

temp_map_from_city

# Remove problematic links and insert replacement links either because links
# don't appear right on the map or because stats for the link don't exist
links_order_from_city <- c(links_order_from_city[!links_order_from_city %in% c(624, 698, 691)],
                    2818, 2820, 1963, 2870, 2872, 1967, 1611, 1609, 1607, 1605, 1602)

# Update with changes
links_map_from_city <- links_segment %>%
  filter(linkid %in% links_order_from_city) %>% 
  arrange(start_lat, ordernumber)

# Missing link between Daws Road and Corunna Avenue. Locate a link between the two
link_daws_cor_from_city <- links_segment %>%
  filter(str_detect(tolower(name), "daws"),
         str_detect(tolower(name), "corunna"),
         direction == "from_city")

# Missing link between Edward Street and Albert Street. Locate a link between the two
link_edw_alb_from_city <- links_segment %>%
  filter(str_detect(tolower(name), "edward"),
         str_detect(tolower(name), "albert"),
         direction == "from_city")

# Missing link between Anzac Highway and Everard Avenue Locate a link between the two
link_anz_ever_from_city <- links_segment %>%
  filter(str_detect(tolower(name), "anzac"),
         str_detect(tolower(name), "everard"),
         direction == "from_city")

temp_map_from_city2 <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_from_city$linkid)) {
  map_df <- links_map_from_city %>% 
    filter(linkid == link)
  
  temp_map_from_city2 <- temp_map_from_city2 %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], label = ~linkid, opacity = 0.3)
  
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

# Check links are correct
temp_map_from_city2 %>%
  addPolylines(data = link_daws_cor_from_city, lng = ~longitude, lat = ~latitude,
               color = "red", label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_edw_alb_from_city, lng = ~longitude, lat = ~latitude,
               color = "red", label = ~linkid, opacity = 0.3) %>% 
  addPolylines(data = link_anz_ever_from_city, lng = ~longitude, lat = ~latitude,
               color = "red", label = ~linkid, opacity = 0.3)

# Combine missing links with map links down DF and plot
links_map_from_city <- links_map_from_city %>% 
  rbind(link_daws_cor_from_city, link_edw_alb_from_city, link_anz_ever_from_city) %>% 
  arrange(start_lat, ordernumber)

# Output final map down
map_from_city <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_from_city$linkid)) {
  map_df <- links_map_from_city %>% 
    filter(linkid == link)
  
  map_from_city <- map_from_city %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], opacity = 0.3, label = ~linkid)
  
  if (n == 1) {
    n <- 2
  } else {
    n <- 1
  }
}

map_from_city

# Save linkid's going south
links_south <- unique(links_map_from_city$linkid)
```

### Links Both Directions Map

```{r}
# Plot links from both directions
map_both <- leaflet() %>% 
  addTiles()

# Add links up map
for (link in unique(links_map_to_city$linkid)) {
  map_df <- links_map_to_city %>% 
    filter(linkid == link)
  
  map_both <- map_both %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "green", opacity = 0.3, label = ~linkid)
}

# Add links down map
for (link in unique(links_map_from_city$linkid)) {
  map_df <- links_map_from_city %>% 
    filter(linkid == link)
  
  map_both <- map_both %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "red", opacity = 0.3, label = ~linkid)
}

map_both

# Save linkid's both directions
links_both <- c(links_north, links_south)
```

### Links with no stats

```{r}
sort(setdiff(links_both, link_stats$linkid))

links_with_stats <- links_segment %>% 
  semi_join(link_stats, by = "linkid")
  
map_links_no_stats <- leaflet() %>% 
  addTiles()

for (link in unique(links_with_stats$linkid)) {
  map_df <- links_with_stats %>% 
    filter(linkid == link)
  
  map_links_no_stats <- map_links_no_stats %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = "yellow", opacity = 1, label = ~linkid)
}

map_links_no_stats
```

## Identify Routes

Routes were identified by examining the [network map](https://www.adelaidemetro.com.au/__data/assets/pdf_file/0009/824247/Adelaide-Metro-network-map.pdf).

All the routes were overlayed on a map on Tableu and routs on South Road were selected and exported.

## Identify Stops

Same as above

```{r}
# Plot on map to check the stops are all on South Rd
stops_segment %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(lat = ~stop_lat, lng = ~stop_lon, label = ~ stop_id)
```

# Analysis

## Calculations

### Trip Times

```{r}
# Ceiling date by aggregate duration. Get time and weekday
trip_times_agg <- trip_times %>% 
  mutate(arrival_time = ceiling_date(arrival_time, "15 mins")) %>% 
  mutate(time = hms::as_hms(arrival_time), .after = arrival_time)

# Without direction

# ## Average delay per stop per timestamp
# stop_delay_stamp <- delays_agg %>%
#   group_by(timestamp, stop_id) %>%
#   summarise(avg_delay = mean(stop_delay)) %>%
#   ungroup()

## Average trip time per aggregated arrival_time
trip_time_arrival <- trip_times_agg %>%
  group_by(arrival_time) %>%
  summarise(avg_time = mean(trip_time)) %>%
  ungroup()

# ## Average delay per stop per time
# stop_delay_time <- delays_agg %>% 
#   group_by(time, stop_id) %>% 
#   summarise(avg_delay = mean(stop_delay)) %>% 
#   ungroup()

## Average trip time per time (hour and minute of the day)
trip_time_hm <- trip_times_agg %>%
  group_by(time) %>% 
  summarise(avg_time = mean(trip_time)) %>% 
  ungroup()

# With direction

# ## Average delay per stop per timestamp per direction
# stop_delay_stamp_dir <- delays_agg %>%
#   group_by(timestamp, stop_id, direction) %>%
#   summarise(avg_delay = mean(stop_delay)) %>%
#   ungroup()

## Average trip time per aggregated arrival_time per direction
trip_time_arrival_dir <- trip_times_agg %>%
  group_by(arrival_time, direction) %>%
  summarise(avg_time = mean(trip_time)) %>%
  ungroup()

# ## Average delay per stop per time per direction
# stop_delay_time_dir <- delays_agg %>%
#   group_by(time, stop_id, direction) %>% 
#   summarise(avg_delay = mean(stop_delay)) %>% 
#   ungroup()

## Average delay of all stops per time per direction (average full road delay by direction)
trip_time_hm_dir <- trip_times_agg %>%
  group_by(time, direction) %>% 
  summarise(avg_time = mean(trip_time)) %>% 
  ungroup()
```

### Congestion

####  Sites

```{r}
sites_agg <- site_stats  %>% 
  mutate(logtime = ceiling_date(logtime, "15 mins")) %>% 
  mutate(time = hms::as_hms(logtime), .after = logtime)

# Average congestion per site per logtime
ind_site_cong_logtime <- sites_agg %>%
  group_by(logtime, siteid) %>%
  summarise(avg_congestion = mean(probecount),
            avg_duration = mean(avgduration)) %>%
  ungroup()

# Average congestion of all sites per logtime (average full road congestion)
sites_cong_logtime <- sites_agg %>%
  group_by(logtime) %>%
  summarise(avg_congestion = mean(probecount),
            avg_duration = mean(avgduration))

# Average congestion per site per time
ind_site_cong_time <- sites_agg %>%
  group_by(time, siteid) %>%
  summarise(avg_congestion = mean(probecount),
            avg_duration = mean(avgduration)) %>% 
  ungroup()

# Average congestion of all sites per time (average full road congestion)
sites_cong_time <- sites_agg %>% 
  group_by(time) %>%
  summarise(avg_congestion = mean(probecount),
            avg_duration = mean(avgduration))
```

#### Links

```{r}
links_agg <- link_stats  %>% 
  mutate(logtime = ceiling_date(logtime, "15 mins")) %>% 
  mutate(time = hms::as_hms(logtime), .after = logtime)

# Average congestion per link per logtime per direction
ind_link_cong_logtime <- links_agg %>%
  group_by(logtime, direction, linkid) %>%
  summarise(avg_congestion = mean(congestion)) %>%
  ungroup()

# Average congestion of all links per logtime per direction (average full road congestion)
links_cong_logtime <- links_agg %>%
  group_by(logtime, direction) %>%
  summarise(avg_congestion = mean(congestion))

# Average congestion per link per time
ind_link_cong_time <- links_agg %>% 
  group_by(time, linkid, direction) %>% 
  summarise(avg_congestion = mean(congestion)) %>% 
  ungroup()

# Average congestion of all links per time (average full road congestion)
links_cong_time <- links_agg %>% 
  group_by(time, direction) %>% 
  summarise(avg_congestion = mean(congestion))
```

## Compare

### Sites

```{r}
compare_trips_sites <- function(timeframe = "10 minutes", plot = "line") {
  trip_times_agg <- trip_times %>% 
  mutate(arrival_time = ceiling_date(arrival_time, timeframe)) %>% 
  mutate(time = hms::as_hms(arrival_time), .after = arrival_time)
  
  sites_agg <- site_stats  %>% 
  mutate(logtime = ceiling_date(logtime, timeframe)) %>% 
  mutate(time = hms::as_hms(logtime), .after = logtime)

  if (plot == "line") {
    
      trip_time_hm <- trip_times_agg %>%
        group_by(time) %>% 
        summarise(avg_time = mean(trip_time)) %>% 
        ungroup()
      
      sites_cong_time <- sites_agg %>% 
        group_by(time) %>%
        summarise(avg_congestion = mean(probecount),
                  avg_duration = mean(avgduration))
      
      trip_time_cong_sites <- trip_time_hm %>% 
        full_join(sites_cong_time)

      trip_time_cong_sites_pivot <- trip_time_cong_sites %>%
        pivot_longer(cols = !time, names_to = "stat", values_to = "value")%>% 
        mutate(stat = recode(stat, avg_congestion = "Avg Congestion", avg_time = "Avg Time (secs)",
                             avg_duration = "Avg Duration (secs)"))

      trip_time_cong_sites_pivot_mor_rush <- trip_time_cong_sites_pivot %>% 
        filter(between(time, as_hms("06:00:00"), as_hms("10:00:00")))

      trip_time_cong_sites_pivot_eve_rush <- trip_time_cong_sites_pivot %>% 
        filter(between(time, as_hms("15:00:00"), as_hms("19:00:00")))
      
      ggplot() +
        geom_line(data = trip_time_cong_sites_pivot, aes(x = time, y = value), alpha = 0.2) +
        geom_line(data = trip_time_cong_sites_pivot_mor_rush, aes(x = time, y = value), color = "blue", size = 0.5) +
        geom_line(data = trip_time_cong_sites_pivot_eve_rush, aes(x = time, y = value), color = "blue", size = 0.5) +
        annotate("rect", xmin = as_hms("06:00:00"), xmax = as_hms("10:00:00"), ymin = -Inf, ymax = Inf,
        fill = "red", alpha = .1) +
        annotate("rect", xmin = as_hms("15:00:00"), xmax = as_hms("19:00:00"), ymin = -Inf, ymax = Inf,
        fill = "red", alpha = .1) +
        facet_grid(rows = vars(stat), scales = "free_y") +
        scale_x_time(breaks = as_hms(c("00:00:00", "06:00:00", "08:00:00", "10:00:00", 
                                       "15:00:00", "17:00:00", "19:00:00")),
                     labels = c("00", "6", "8", "10", "15", "17", "19")) +
        labs(x = "Time", y = "") +
        theme_minimal()
  } else if (plot == "scatter") {
      trip_time_arrival <- trip_times_agg %>%
        group_by(arrival_time) %>%
        summarise(avg_time = mean(trip_time)) %>%
        ungroup()
      
      sites_cong_logtime <- sites_agg %>%
        group_by(logtime) %>%
        summarise(avg_congestion = mean(probecount),
                  avg_duration = mean(avgduration))
      
      trip_time_cong_sites_scatter <- trip_time_arrival %>% 
        inner_join(sites_cong_logtime, by = c("arrival_time" = "logtime")) %>% 
        filter(between(as_hms(arrival_time), as_hms("06:00:00"), as_hms("10:00:00")) |
                 between(as_hms(arrival_time), as_hms("15:00:00"), as_hms("19:00:00")))

      ggplot(trip_time_cong_sites_scatter, aes(x = avg_congestion, y = avg_time)) +
        geom_point() +
        geom_smooth(se = FALSE) +
        labs(x = "Avg Congestion", y = "Avg Time (secs)") +
        theme_minimal()
  } 
}
```

```{r}
compare_trips_sites <- function(aggregate = "time", timeframe = "10 minutes", plot = "line") {
  trip_times_agg <- trip_times %>% 
  mutate(arrival_time = ceiling_date(arrival_time, timeframe)) %>% 
  mutate(time = hms::as_hms(arrival_time), .after = arrival_time)
  
  sites_agg <- site_stats  %>% 
  mutate(logtime = ceiling_date(logtime, timeframe)) %>% 
  mutate(time = hms::as_hms(logtime), .after = logtime)

  if (plot == "line") {
    if (aggregate == "time") {
      trip_time_hm <- trip_times_agg %>%
        group_by(time) %>% 
        summarise(avg_time = mean(trip_time)) %>% 
        ungroup()
      
      sites_cong_time <- sites_agg %>% 
        group_by(time) %>%
        summarise(avg_congestion = mean(probecount),
                  avg_duration = mean(avgduration))
      
      trip_time_cong_sites <- trip_time_hm %>% 
        full_join(sites_cong_time)

      trip_time_cong_sites_pivot <- trip_time_cong_sites %>%
        pivot_longer(cols = !time, names_to = "stat", values_to = "value")%>% 
        mutate(stat = recode(stat, avg_congestion = "Avg Congestion", avg_time = "Avg Time (secs)",
                             avg_duration = "Avg Duration (secs)"))

      trip_time_cong_sites_pivot_mor_rush <- trip_time_cong_sites_pivot %>% 
        filter(between(time, as_hms("06:00:00"), as_hms("10:00:00")))

      trip_time_cong_sites_pivot_eve_rush <- trip_time_cong_sites_pivot %>% 
        filter(between(time, as_hms("15:00:00"), as_hms("19:00:00")))
      
      ggplot() +
        geom_line(data = trip_time_cong_sites_pivot, aes(x = time, y = value), alpha = 0.2) +
        geom_line(data = trip_time_cong_sites_pivot_mor_rush, aes(x = time, y = value), color = "blue", size = 0.5) +
        geom_line(data = trip_time_cong_sites_pivot_eve_rush, aes(x = time, y = value), color = "blue", size = 0.5) +
        annotate("rect", xmin = as_hms("06:00:00"), xmax = as_hms("10:00:00"), ymin = -Inf, ymax = Inf,
        fill = "red", alpha = .1) +
        annotate("rect", xmin = as_hms("15:00:00"), xmax = as_hms("19:00:00"), ymin = -Inf, ymax = Inf,
        fill = "red", alpha = .1) +
        facet_grid(rows = vars(stat), scales = "free_y") +
        scale_x_time(breaks = as_hms(c("00:00:00", "06:00:00", "08:00:00", "10:00:00", 
                                       "15:00:00", "17:00:00", "19:00:00")),
                     labels = c("00", "6", "8", "10", "15", "17", "19")) +
        labs(x = "Time", y = "") +
        theme_minimal()
    } else if (aggregate == "day") {
      trip_time_arrival <- trip_times_agg %>%
        group_by(arrival_time) %>%
        summarise(avg_time = mean(trip_time)) %>%
        ungroup()
      
      sites_cong_logtime <- sites_agg %>%
        group_by(logtime) %>%
        summarise(avg_congestion = mean(probecount),
                  avg_duration = mean(avgduration))
      
      trip_time_cong_sites <- trip_time_arrival %>% 
        full_join(sites_cong_logtime, by = c("arrival_time" = "logtime"))

      trip_time_cong_sites_pivot <- trip_time_cong_sites %>%
        pivot_longer(cols = !arrival_time, names_to = "stat", values_to = "value")%>% 
        mutate(stat = recode(stat, avg_congestion = "Avg Congestion", avg_time = "Avg Time (secs)",
                             avg_duration = "Avg Duration (secs)"))

      trip_time_cong_sites_pivot_mor_rush <- trip_time_cong_sites_pivot %>% 
        filter(between(arrival_time, as_hms("06:00:00"), as_hms("10:00:00")))

      trip_time_cong_sites_pivot_eve_rush <- trip_time_cong_sites_pivot %>% 
        filter(between(arrival_time, as_hms("15:00:00"), as_hms("19:00:00")))
      
      ggplot() +
        geom_line(data = trip_time_cong_sites_pivot, aes(x = arrival_time, y = value)) +
        geom_line(data = trip_time_cong_sites_pivot_mor_rush, aes(x = arrival_time, y = value), color = "blue", size = 0.5) +
        geom_line(data = trip_time_cong_sites_pivot_eve_rush, aes(x = arrival_time, y = value), color = "blue", size = 0.5) +
        # annotate("rect", xmin = as_hms("06:00:00"), xmax = as_hms("10:00:00"), ymin = -Inf, ymax = Inf,
        # fill = "red", alpha = .1) +
        # annotate("rect", xmin = as_hms("15:00:00"), xmax = as_hms("19:00:00"), ymin = -Inf, ymax = Inf,
        # fill = "red", alpha = .1) +
        facet_grid(rows = vars(stat), scales = "free_y") +
        # scale_x_time(breaks = as_hms(c("00:00:00", "06:00:00", "08:00:00", "10:00:00", 
        #                                "15:00:00", "17:00:00", "19:00:00")),
        #              labels = c("00", "6", "8", "10", "15", "17", "19")) +
        labs(x = "Time", y = "") +
        theme_minimal()
    }
      
  } else if (plot == "scatter") {
      trip_time_arrival <- trip_times_agg %>%
        group_by(arrival_time) %>%
        summarise(avg_time = mean(trip_time)) %>%
        ungroup()
      
      sites_cong_logtime <- sites_agg %>%
        group_by(logtime) %>%
        summarise(avg_congestion = mean(probecount),
                  avg_duration = mean(avgduration))
      
      trip_time_cong_sites_scatter <- trip_time_arrival %>% 
        inner_join(sites_cong_logtime, by = c("arrival_time" = "logtime")) %>% 
        filter(between(as_hms(arrival_time), as_hms("06:00:00"), as_hms("10:00:00")) |
                 between(as_hms(arrival_time), as_hms("15:00:00"), as_hms("19:00:00")))

      ggplot(trip_time_cong_sites_scatter, aes(x = avg_congestion, y = avg_time)) +
        geom_point() +
        geom_smooth(se = FALSE) +
        labs(x = "Avg Congestion", y = "Avg Time (secs)") +
        theme_minimal()
  } 
}
```


### Links

```{r}
compare_trips_links <- function(timeframe = "15 minutes", plot = "line", measure = congestion){
  if (!deparse(substitute(measure)) %in% names(link_stats)[3:11]) {
    stop(paste("Measure must be one of", paste(names(link_stats)[3:11], collapse = ", ")))
  }
  
  trip_times_agg <- trip_times %>% 
  mutate(arrival_time = ceiling_date(arrival_time, timeframe)) %>% 
  mutate(time = hms::as_hms(arrival_time), .after = arrival_time)

  links_agg <- link_stats  %>% 
  mutate(logtime = ceiling_date(logtime, timeframe)) %>% 
  mutate(time = hms::as_hms(logtime), .after = logtime)

  if (plot == "line") {
    
      trip_time_hm_dir <- trip_times_agg %>%
        group_by(time, direction) %>% 
        summarise(avg_time = mean(trip_time)) %>% 
        ungroup()
      
      links_cong_time <- links_agg %>% 
        group_by(time, direction) %>% 
        summarise(avg_congestion = mean({{measure}}))
      
      trip_time_cong_links <- trip_time_hm_dir %>% 
        full_join(links_cong_time)

      trip_time_cong_links_pivot <- trip_time_cong_links %>%
        pivot_longer(cols = avg_time:avg_congestion, names_to = "stat", values_to = "value") %>% 
        mutate(direction = recode(direction, from_city = "From City", to_city = "To City"),
               stat = recode(stat, avg_congestion = "Avg Congestion", avg_time = "Avg Time (secs)"))
      
      trip_time_cong_links_pivot_mor_rush <- trip_time_cong_links_pivot %>% 
        filter(between(time, as_hms("06:00:00"), as_hms("10:00:00")))
      
      trip_time_cong_links_pivot_eve_rush <- trip_time_cong_links_pivot %>% 
        filter(between(time, as_hms("15:00:00"), as_hms("19:00:00")))
      
      ggplot() +
        geom_line(data = trip_time_cong_links_pivot, aes(x = time, y = value), alpha = 0.2) +
        geom_line(data = trip_time_cong_links_pivot_mor_rush, aes(x = time, y = value), color = "blue", size = 0.5) +
        geom_line(data = trip_time_cong_links_pivot_eve_rush, aes(x = time, y = value), color = "blue", size = 0.5) +
        annotate("rect", xmin = as_hms("06:00:00"), xmax = as_hms("10:00:00"), ymin = -Inf, ymax = Inf,
        fill = "red", alpha = .1) +
        annotate("rect", xmin = as_hms("15:00:00"), xmax = as_hms("19:00:00"), ymin = -Inf, ymax = Inf,
        fill = "red", alpha = .1) +
        facet_grid(rows = vars(stat), cols = vars(direction), scales = "free_y") +
        scale_x_time(breaks = as_hms(c("00:00:00", "06:00:00", "08:00:00", "10:00:00", 
                                       "15:00:00", "17:00:00", "19:00:00")),
                     labels = c("00", "6", "8", "10", "15", "17", "19")) +
        labs(x = "Time", y = "") +
        theme_minimal()
  } else if (plot == "scatter") {
    
      trip_time_arrival_dir <- trip_times_agg %>%
        group_by(arrival_time, direction) %>%
        summarise(avg_time = mean(trip_time)) %>%
        ungroup()
      
      links_cong_logtime <- links_agg %>%
        group_by(logtime, direction) %>%
        summarise(avg_congestion = mean({{measure}}))
      
      trip_time_cong_links_scatter <- trip_time_arrival_dir %>% 
        inner_join(links_cong_logtime, by = c("arrival_time" = "logtime", "direction")) %>% 
        filter(between(as_hms(arrival_time), as_hms("06:00:00"), as_hms("10:00:00")) |
                 between(as_hms(arrival_time), as_hms("15:00:00"), as_hms("19:00:00")))

      ggplot(trip_time_cong_links_scatter, aes(x = avg_congestion, y = avg_time)) +
        geom_point() +
        geom_smooth(se = FALSE) +
        labs(x = "Avg Congestion", y = "Avg Time (secs)") +
        theme_minimal()
  }
}
```


```{r}
compare_trips_sites(timeframe = "15 minutes", aggregate = "day")
```

```{r}
compare_trips_links(timeframe = "30 minutes", measure = score)
```














































