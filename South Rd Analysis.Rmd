---
title: "South Rd Analysis"
author: "Ibrahim Al-Hindi"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
# Libraries
library(tidyverse)
library(here)
library(lubridate)
library(ggmap)
library(sf)
library(leaflet)
library(geosphere)
library(geodist)
```

```{r}
# Data
sites_raw <- read_csv(here("data/addinsight/addinsight_prod.btsites.csv.csv"))
links_raw <- read_csv(here("data/addinsight/addinsight_prod.btlinks.csv.csv"))
links_south_rd <- read_csv(here("data/South-Rd/BT Links - South Rd.csv")) 
```

# Data Wrangling

```{r}
# Sites

## Remove duplicates
sites <- sites_raw %>% 
  distinct(id, .keep_all = TRUE)

rm(sites_raw)

## DF with sites and coordinates only
sites_coords <- sites %>% 
  select(id, longitude, latitude)

# Links

links <- links_raw %>% 
  distinct(id, .keep_all = TRUE)

rm(links_raw)

## Links DF for leaflet

### add origin site coordinates
links_origin <- links %>% 
  left_join(sites_coords, by = c("originid" = "id"))

### add destination site coordinates
links_dest <- links %>% 
  left_join(sites_coords, by = c("destid" = "id"))

### Row bind links_south_origin and links_south_dest
links_leaflet <- bind_rows("origin" = links_origin, "dest" = links_dest, .id = "point") %>% 
  arrange(id)

# Links_south_rd

links_south_rd <- links_south_rd %>% 
  rename_with(tolower)
```

# Getting Information for Analysis

## Identify Sites

Select sites from map on South Road between Anzac Highway and Ayliffs Road

```{r}
sites %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(label = ~ id, fillOpacity = 1)
```

Use Google maps to determine coordinates at each intersection of South Road required and get the sites within those coordinates

```{r}
sites_south <- sites %>% 
  filter(str_detect(tolower(name), pattern = "south road") |
           str_detect(tolower(instance_id), pattern = "south road"),
         between(longitude, 138.5710, 138.5763),
         between(latitude, -35.0116, -34.9420))

# Map to double check
sites_south %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircles(label = ~ id, fillOpacity = 1)
```

## Identify Links

### Ibrahim Links

Get all links that have a start site and end site in the sites identified

```{r}
# links_south <- links_leaflet %>% 
#   filter(originid %in% sites_south$id,
#          destid %in% sites_south$id)
# 
# # Map to check the sites are all in the correct spot. They are
# links_south %>% 
#   leaflet() %>% 
#     addTiles() %>% 
#     addPolylines(lng = ~longitude, lat = ~latitude, group = ~id)
```

Next: need to select sites along the road but do not overlap

### Alex Links

```{r}
# Mutate start and end longitudes for each link
links_south_rd <- links_south_rd %>% 
  group_by(linkid) %>%
  mutate(up_lat = min(latitude),
         down_lat = max(latitude),
         lat_diff = down_lat -  up_lat) %>%
  ungroup()

links_south_rd <- links_south_rd %>% 
  group_by(linkid) %>%
  arrange(ordernumber, .by_group = TRUE) %>% 
  mutate(up_lat = min(latitude),
         down_lat = max(latitude),
         lat_diff = down_lat -  up_lat,
         going_up = lag(latitude) > latitude) %>% 
  fill(going_up, .direction = "up") %>% 
  ungroup()

# Keep one row per linkid for now to see sequence of links
links_dist <- links_south_rd %>% 
  distinct(linkid, .keep_all = TRUE) %>%
  # Build map for lower end of map to upper
  arrange(up_lat, -lat_diff) %>% 
  # If two links have the same up_lat, keep the one that covers larger distance
  group_by(up_lat) %>% 
  filter(lat_diff == max(lat_diff)) %>% 
  ungroup()
```

```{r}
# Identifying sequence of links with no overlaps

flag <- links_dist$down_lat[1]

links_order <- vector("list")

links_order[[1]] <- links_dist[1,]

n <- 2

for (i in 2:nrow(links_dist)) {
  if (links_dist$up_lat[i] > flag) {
    links_order[[n]] <- links_dist[i,]
    
    flag <- links_dist$down_lat[i]
    
    n <- n+1
  }
}

links_order <- bind_rows(links_order)
```

```{r}
links_map <- links_south_rd %>% 
  semi_join(links_order, by = "linkid")

# Set color palette for leaflet legend
pal <- colorFactor(palette = "Set1",
                   domain = unique(links_map$linkid))


links_colors <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6")

n <- 1

map1 <- leaflet() %>% 
  addTiles()

for (link in unique(links_map$linkid)) {
  map_df <- links_map %>% 
    filter(linkid == link)
  
  map1 <- map1 %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], label = ~linkid, opacity = 1)
  
  n <- n+1
}

map1

# Missing link between Daws Road and Corunna Avenua. Locate a link between the two
link_daws_cor <- 
  links_south_rd %>% 
  filter(str_detect(tolower(name), "daws"),
         str_detect(tolower(name), "corunna")) %>% 
  # pick one of the routes
  filter(linkid == 696)


map1 %>% 
  addPolylines(data = link_daws_cor, lng = ~longitude, lat = ~latitude, color = "yellow", label = ~linkid, opacity = 1)
```









```{r}
# Mutate start and end longitudes for each link
links_south_rd_dir <- links_south_rd %>% 
  group_by(linkid) %>%
  arrange(ordernumber, .by_group = TRUE) %>% 
  mutate(up_lat = max(latitude),
         down_lat = min(latitude),
         lat_diff = down_lat -  up_lat,
         going_up = lag(latitude) < latitude) %>% 
  fill(going_up, .direction = "up") %>% 
  ungroup()
```

#### Build map going up

```{r}
links_up <- links_south_rd_dir %>% 
  filter(going_up == TRUE)

# Keep one row per linkid for now to see sequence of links
links_dist_up <- links_up %>% 
  distinct(linkid, .keep_all = TRUE) %>%
  # Build map for lower end of map to upper
  arrange(up_lat, -lat_diff) %>% 
  # If two links have the same up_lat, keep the one that covers larger distance
  group_by(up_lat) %>% 
  filter(lat_diff == max(lat_diff)) %>% 
  ungroup()
```


```{r}
# Identifying sequence of links with no overlaps

flag <- links_dist_up$down_lat[1]

links_order <- vector("list")

links_order[[1]] <- links_dist_up[1,]

n <- 2

for (i in 2:nrow(links_dist_up)) {
  if (links_dist_up$up_lat[i] > flag) {
    links_order[[n]] <- links_dist_up[i,]
    
    flag <- links_dist_up$down_lat[i]
    
    n <- n+1
  }
}

links_order_up <- bind_rows(links_order)
```

```{r}
links_map_up <- links_south_rd_dir %>% 
  semi_join(links_order_up, by = "linkid")

links_colors <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6")

n <- 1

map1 <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_up$linkid)) {
  map_df <- links_map_up %>% 
    filter(linkid == link)
  
  map1 <- map1 %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], label = ~linkid, opacity = 1)
  
  n <- n+1
}

map1

# Missing link between Daws Road and Corunna Avenua. Locate a link between the two
link_daws_cor <- 
  links_south_rd_dir %>% 
  filter(str_detect(tolower(name), "daws"),
         str_detect(tolower(name), "corunna")) %>% 
  # pick one of the routes
  filter(linkid == 696)


map1 %>% 
  addPolylines(data = link_daws_cor, lng = ~longitude, lat = ~latitude, color = "yellow", label = ~linkid, opacity = 1)
```


#### Build map going down

```{r}
links_down <- links_south_rd_dir %>% 
  filter(going_up == FALSE)

# Keep one row per linkid for now to see sequence of links
links_dist_down <- links_down %>% 
  distinct(linkid, .keep_all = TRUE) %>%
  # Build map for lower end of map to upper
  arrange(-up_lat, -lat_diff) %>% 
  # If two links have the same up_lat, keep the one that covers larger distance
  group_by(up_lat) %>% 
  filter(lat_diff == max(lat_diff)) %>% 
  ungroup()
```


```{r}
# Identifying sequence of links with no overlaps

flag <- links_dist_down$down_lat[1]

links_order <- vector("list")

links_order[[1]] <- links_dist_down[1,]

n <- 2

for (i in 2:nrow(links_dist_down)) {
  if (links_dist_down$up_lat[i] < flag) {
    links_order[[n]] <- links_dist_down[i,]
    
    flag <- links_dist_down$down_lat[i]
    
    n <- n+1
  }
}

links_order_down <- bind_rows(links_order)
```

```{r}
links_map_down <- links_south_rd_dir %>% 
  semi_join(links_order_down, by = "linkid")

links_colors <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6")

n <- 1

map1 <- leaflet() %>% 
  addTiles()

for (link in unique(links_map_down$linkid)) {
  map_df <- links_map_down %>% 
    filter(linkid == link)
  
  map1 <- map1 %>% 
    addPolylines(data = map_df, lng = ~longitude, lat = ~latitude, color = links_colors[n], label = ~linkid, opacity =1)
  
  n <- n+1
}

map1
```






